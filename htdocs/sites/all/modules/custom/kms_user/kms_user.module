<?php

function kms_user_cron() {
  
}

function kms_user_ctools_plugin_directory($owner, $plugin_type) {
  // we'll be nice and limit scandir() calls
  // if (in_array($owner, array('ctools', 'addressfield'))) {
  if (in_array($owner, array('ctools'))) {
    return "plugins/$plugin_type";
  }
}

function kms_user_form_alter(&$form, &$form_state, $form_id) {
  if (in_array($form_id, array('user_register_form', 'user_profile_form'))) {
    $form['account']['name']['#element_validate'] = array('_kms_user_validate_username');
    $form['account']['name']['#description'] = t(
      'Spaces are not allowed; punctuation is not allowed except for periods, hyphens, apostrophes, and underscores.'
    );
  }
}

// function kms_user_form_user_profile_form_alter(&$form, &$form_state, $form_id) {
//   $form['account']['name']['#element_validate'] = array('_kms_user_validate_username');
//   $form['account']['name']['#description'] = t(
//     'Spaces are not allowed; punctuation is not allowed except for periods, hyphens, apostrophes, and underscores.'
//   );
// }

function kms_user_form_user_register_form_alter(&$form, &$form_state, $form_id) {
  global $user;
  if ($user->uid == 0) {
      $form['field_terms_and_conditions']['#after_build'] = array('kms_user_register_after_build');
  }
}

function kms_user_register_after_build($form_element) {
    //adapt_debug('tom', $form_element['und']);
    $terms_and_conditions = 'Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
proident, sunt in culpa qui officia deserunt mollit anim id est laborum.';

    $form_element['und']["#description"] = ' ( <a href="#" id="terms_and_conditions_link">'.t('Read here').'</a> )';
    $form_element['und']['#suffix'] = '<div id="terms_and_conditions" style="display:none;">' . $terms_and_conditions .'<a id="terms_and_conditions_close" class="close_overlay" href="#">close</a></div>';

    drupal_add_js(drupal_get_path('module', 'kms_user') .'/js/jquery.lightbox_me.js');
    drupal_add_js("jQuery(function() { 
               jQuery('#terms_and_conditions_link').click(function(e) { 
                 jQuery('#terms_and_conditions').lightbox_me({ centered: true });
                 e.preventDefault(); 
               }); });",'inline');

    return $form_element;
}


function kms_user_auth_test() {
  require_once DRUPAL_ROOT . '/' . variable_get('password_inc', 'includes/password.inc');  $stored_hash = "$S$Dcal7Lv.PBorAyoc5tqmA9m7.oXkSYiXGB4QUFZ59ru87.0XarV6";
  $password = "1234";
  $stored_hash = "$S$Dcal7Lv.PBorAyoc5tqmA9m7.oXkSYiXGB4QUFZ59ru87.0XarV6";
  // var_dump(mb_detect_encoding($stored_hash, 'UTF-8, ISO-8859-1', TRUE));
  var_dump(mb_strlen($stored_hash));
  $user = user_load(10);
  $stored_hash = $user->pass;
  // var_dump(mb_detect_encoding($stored_hash, 'UTF-8, ISO-8859-1', TRUE));
  var_dump(mb_strlen($stored_hash));
  var_dump(_password_crypt('sha512', $password, $stored_hash));
  var_dump('heps');
  // die;
}


function _kms_user_validate_username($element, &$form_state, $form) {
  if (!empty($element['#value'])) {
    preg_match_all("#(\/)|(\\\\)|(=)|(\?)|(\&)|(\s)#Uis", $element['#value'], $m);
    foreach ($m as $match) {
      if (!empty($match)) {
        form_error($element, t('Username contains invalid characters.'));
        return;
      }
    }
  }
}



// function _kms_user_phone_render_address(&$format) {
//   $address = $format['#address'];
//   $format['phone_block'] = array(
//     '#title' => t('Phone'),
//     '#type' => 'addressfield_container',
//     'phone_number' => array(
//       '#title' => t('Phone'),
//       '#size' => 15,
//       '#attributes' => array('class' => array('phone-number')),
//       '#tag' => 'span',
//     )
//   );
// }

/**
 * Format callback.
 *
 * @see CALLBACK_addressfield_format_callback()
 */
// function kms_user_format_phone_generate(&$format, $address, $context) {
//   if ($context['mode'] == 'form') {
//     $format['phone_block'] = array(
//       '#type' => 'addressfield_container',
//       '#attributes' => array('class' => array('custom-block')),
//       '#weight' => 200,
//     );
//     $format['phone_block']['phone_number'] = array(
//       '#title' => t('Phone'),
//       '#size' => 15,
//       '#attributes' => array('class' => array('phone-number')),
//       '#type' => 'textfield',
//       '#tag' => 'span',
//       '#default_value' => isset($address['phone_number']) ? $address['phone_number'] : '',
      
//     );
//   }
//   else {
//     // Add our own render callback for the format view
//     $format['#pre_render'][] = '_kms_user_phone_render_address';
//   }
// }
