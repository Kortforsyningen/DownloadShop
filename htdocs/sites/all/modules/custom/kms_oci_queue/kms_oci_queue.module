<?php
/**
 * @file
 * kms_oci_queue.module
 * Handle query queues.
 *
 * @author Mikkel Jakobsen <mikkel@adapt.dk>
 */

define('KMS_OCI_QUEUE_PREFIX', 'kms_oci_queue');
define('KMS_OCI_QUEUE_ENGINE_ROOT_URI', 'public://' . KMS_OCI_QUEUE_PREFIX);
define('KMS_OCI_QUEUE_ENGINE_DIR_JOBS', 'jobs');
define('KMS_OCI_QUEUE_ENGINE_DIR_JOBS_PROCESSED', 'jobs_processed');
define('KMS_OCI_QUEUE_ACTION_USER_SAVE', 'user_save');
define('KMS_OCI_QUEUE_ACTION_USER_DELETE', 'user_delete');
define('KMS_OCI_QUEUE_ACTION_BUNDLES_ATTACH', 'bundles_attach');
define('KMS_OCI_QUEUE_ACTION_BUNDLE_SAVE', 'bundle_save');
define('KMS_OCI_QUEUE_ACTION_BUNDLE_DELETE', 'bundle_delete');
define('KMS_OCI_QUEUE_CRON_DELETE_JOBS_MAX', 50);
// Atodo: Remove this after testing. And remove usages!
define('KMS_OCI_QUEUE_DEBUG', TRUE);

/**
 * Implements hook_menu().
 */
function kms_oci_queue_menu() {
  $items = array();
  $items['admin/reports/kms-oci-queue'] = array(
    'title' => 'Oci queue status',
    'description' => 'Show oci queue status',
    'page callback' => 'kms_oci_queue_admin_page',
    'access arguments' => array('administer kms oci queue'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['kms-oci-queue/ajax/load-log/%'] = array(
    'title' => 'Show job log',
    'page callback' => 'kms_oci_queue_admin_page_ajax_job_log',
    'access arguments' => array('administer kms oci queue'),
    'page arguments' => array(3),
    'type' => MENU_CALLBACK,
  );
  $items['kms-oci-queue/ajax/load-statuses'] = array(
    'title' => 'Show job log',
    'page callback' => 'kms_oci_queue_admin_page_ajax_job_statuses',
    'access arguments' => array('administer kms oci queue'),
//    'page arguments' => array(3),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function kms_oci_queue_permission() {
  return array(
    'administer kms oci queue' => array(
      'title' => t('Administer Kms Oci Queue.'),
    ),
  );
}

/**
 * Implements hook_ctools_plugin_type().
 */
function kms_oci_queue_ctools_plugin_type() {
  return array(
    'queue_runner' => array(
      'use hooks' => FALSE,
    ),
  );
}

/**
 * Implements hook_cronapi().
 */
function kms_oci_queue_cronapi($op, $job = NULL) {
  switch ($op) {
    case 'list':
      return array(
        'kms_oci_queue_query_creator_run' => 'Run query creator',
        'kms_oci_queue_cleanup_jobs' => 'Cleanup job queue',
      );

    case 'rule':
      switch ($job) {
        case 'kms_oci_queue_query_creator_run': return '*/1 * * * *';
        case 'kms_oci_queue_cleanup_jobs': return '*/30 * * * *';
          break;
      }
      break;

    case 'execute':
      switch ($job) {
        case 'kms_oci_queue_query_creator_run':
          kms_oci_queue_query_creator_run();
          break;

        case 'kms_oci_queue_cleanup_jobs':
          kms_oci_queue_cron_cleanup_jobs();
          break;
      }
      break;
  }

}

/**
 * Implements hook_cron_queue_info().
 */
function kms_oci_queue_cron_queue_info() {
  $queues['kms_oci_queue_query'] = array(
    'worker callback' => 'kms_oci_queue_query_run',
    'time' => 120,
  );
  return $queues;
}

/**
 * Process a job queue item of the query creator queue.
 */
function kms_oci_queue_query_creator_run() {
  // Load query creator queue.
  $creator_queue = DrupalQueue::get(
    KmsOciQueueJob::$queues['creator']['name'],
    TRUE
  );
  // Load query executor queue.
  $exe_queue = DrupalQueue::get(
    KmsOciQueueJob::$queues['executor']['name'],
    TRUE
  );
  // Get query creator item.
  $item = $creator_queue->claimItem();
  // If no queue item found do nothing.
  if (!$item) {
    return;
  }
  // Find job id.
  $jid = $item->item_id;
  // Creator item with data to create query queue.
  $creator_item = $item->data;
  // We need parameters in order to create queries.
  if (empty($creator_item->params)) {
    return;
  }
  // Do not need original item anymore.
  unset($item);

  // Create executor queue items via ctools plugins.
  ctools_include('plugins');
  $plugins = ctools_get_plugins('kms_oci_queue', 'queue_runner');
  $line_num = 0;
  array_walk(
    $plugins,
    function($plugin) use ($jid, $creator_item, $exe_queue, &$line_num) {
    // Only load plugins corresponding to the queue item action.
      if ($plugin['type'] != $creator_item->action) {
        return;
      }
    // Get proper plugin function in order to create executor items.
      if ($function = ctools_plugin_get_function($plugin, 'query_creator_run')) {
        $line_num = $function($jid, $creator_item, $exe_queue);
      }
  });

  // If line number is returned from plugin(s) then write it in log.
  // Atodo: Fix this.
  // There are problems with line numbers right now.
  // Among others the connection id tied to a job.
  // So we just change status to processing.
//  if ($line_num) {
    $job = KmsOciQueueJobFactory::get($jid);
    $job->changeStatus(KmsOciQueueJob::STATUS_PROCESSING);
//  }

}

/**
 * Process a job queue item of the query queue.
 *
 * @param object $item
 *   Queue item object.
 */
function kms_oci_queue_query_run($item) {
  // Load query queue executor plugins to create sql output.
  ctools_include('plugins');
  $plugins = ctools_get_plugins('kms_oci_queue', 'queue_runner');
  $output = '';
  array_walk($plugins, function($plugin) use ($item, &$output) {
    // Only load plugins corresponding to the queue item action.
    if ($plugin['type'] != $item->action) {
      return;
    }
    // Accumulate output.
    if ($function = ctools_plugin_get_function($plugin, 'query_run')) {
      $output .= $function($item);
    }
  });
  $job = KmsOciQueueJobFactory::get($item->jid);
  // Construct filenames / paths.
  $tmp_filename = sprintf('temporary://%s.tmp', $job->jid);
  // Write job (sql) file.
  $filename = $job->jid . '.job';
  $dest_name = implode(
    '/',
    array(
      KMS_OCI_QUEUE_ENGINE_ROOT_URI,
      KMS_OCI_QUEUE_ENGINE_DIR_JOBS,
      $filename,
    )
  );
  // If no output return (do nothing).
  if (empty($output) && $item->is_last_item && !file_exists($tmp_filename)) {
    $job->changeStatus(
      KmsOciQueueJob::STATUS_DONE,
      'No lines to process in this job'
    );
    $job->finishQueue();
    return;
  }
  elseif (empty($output)) {
    return;
  }

  // Append output to tmp file.
  if (file_put_contents($tmp_filename, $output, FILE_APPEND) === FALSE) {
    $job->changeStatus(
      KmsOciQueueJob::STATUS_FAILED,
      'File creation failed. Could not write to tmp dir.'
    );
  }
  // If last line has been written move tmp file to actual destination dir.
  elseif ($item->is_last_item) {
    $move = file_unmanaged_move($tmp_filename, $dest_name, FILE_EXISTS_REPLACE);
    if ($move) {
      $job->changeStatus(
        KmsOciQueueJob::STATUS_FILE_READY,
        'File creation succeeded. Saved in %filepath',
        array('%filepath' => $move)
      );
      $job->finishQueue();
    }
    else {
      $job->changeStatus(
        KmsOciQueueJob::STATUS_FAILED,
        'File creation failed. Cannot move filename from tmp dir.'
      );
    }

  }
}

/**
 * Get all current job ids.
 *
 * @param array $job_statuses
 *   Possbility for including/excluding jobs with certain statuses.
 *
 * @return array
 *   Array of all current job ids.
 */
function kms_oci_queue_get_job_ids($job_statuses = array()) {
  $job_statuses += array(
    'include' => array(),
    'exclude' => array(),
  );
  $query = db_select('kms_oci_queue_job', 'j')->fields('j', array('jid'));
  if (!empty($job_statuses['include'])) {
    $query->condition('j.status', $job_statuses['include'], 'IN');
  }
  if (!empty($job_statuses['exclude'])) {
    $query->condition('j.status', $job_statuses['exclude'], 'NOT IN');
  }
  $result = $query->orderBy('jid')->execute()->fetchCol();
  return $result ?: array();
}

/**
 * Show Kms oci report page.
 *
 * @return array
 *   Render array.
 */
function kms_oci_queue_admin_page() {
  drupal_add_library('system', 'jquery.cookie');
  drupal_add_js(drupal_get_path('module', 'kms_oci_queue') . '/js/kms_oci_queue_reports.js');
  drupal_add_css(drupal_get_path('module', 'kms_oci_queue') . '/css/kms_oci_queue_reports.css');

  $output['queues'] = kms_oci_queue_admin_page_jobs(
    array('exclude' => array(KmsOciQueueJob::STATUS_DONE))
  );
  $output['queues'] += kms_oci_queue_admin_page_jobs(
    array('include' => array(KmsOciQueueJob::STATUS_DONE)),
    t('Jobs done')
  );

  return $output;
}

/**
 * Render table with kms oci jobs.
 *
 * @return array
 *   Render array.
 */
function kms_oci_queue_admin_page_jobs($job_statuses, $title = '') {
  $output = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array('kms-oci-queue-jobs-overview'),
    ),
  );

  $jobs_output = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array('kms-oci-queue-jobs'),
    ),
  );
  $jobs_output["job_queue_title"] = array(
    '#type' => 'html_tag',
    '#tag' => 'h2',
    '#value' => !empty($title) ? $title : t('Jobs'),
  );
  $rows = array();
  foreach (kms_oci_queue_get_job_ids($job_statuses) as $jid) {
    $job = KmsOciQueueJobFactory::get($jid);
    $job_action = $job->action . ' [<a href="#" class="more">' . t('info') . '</a>]';
    $rows[] = array(
      'data' => array(
        array(
          'data' => $job->jid,
          'data-jid' => $job->jid,
          'class' => 'job-log-trigger',
        ),
        array(
          'data' => $job_action,
          'data-jid' => $job->jid,
          'class' => array('job-info'),
        ),
        array(
          'data' => $job->status->message,
          'data-jid' => $job->jid,
          'class' => array(
            'status',
            KmsOciQueueJob::cssClassStatus($job->status->status),
          ),
        ),
        array('data' => format_date($job->created)),
      ),
    );

    $options['job_info_beautytip_' . $job->jid] = array(
      'cssSelect' => 'td[data-jid="' . $job->jid .  '"].job-info .more',
      'trigger' => array(0 => 'mouseover', 1 => 'click'),
      'text' => $job->actionDetails,
      'width' => 400,
    );
    beautytips_add_beautytips($options);

    $rows[] = array(
      'class' => array('kms-oci-queue-job-log'),
      'data-jid' => $job->jid,
      'data' => array(
        array('data' => '&nbsp;', 'colspan' => 4),
      ),
    );
  }

  if (empty($rows)) {
    $rows[] = array(
      'data' => array(
        array('data' => t('There are currently no jobs.'), 'colspan' => 4),
      ),
    );
  }

  $jobs_output["job_queue"] = array(
    '#theme' => 'table',
    '#header' => array(t('Job id'), t('Info'), t('Status'), t('Created')),
    '#rows' => $rows,
  );

  $table_id = "kms_oci_queue_jobs_" . md5(serialize($job_statuses));
  $output[$table_id] = $jobs_output;

  return $output;
}

/**
 * Print a log for a given job.
 * 
 * @param int $jid
 *   Job id
 */
function kms_oci_queue_admin_page_ajax_job_log($jid) {
  if (empty($jid)) {
    return;
  }
  $json['html'] = '';
  $job = KmsOciQueueJobFactory::get($jid);
  if (!empty($job)) {
    $log = $job->getLog();
  }
  $output = array();
  if (!empty($log)) {
    foreach ($log as $lid => $entry) {
      $message_vars = unserialize($entry->variables);
      if (empty($message_vars) || !is_array($message_vars)) {
        $message_vars = array();
      }
      $classes = array(KmsOciQueueJob::cssClassSeverity($entry->severity));
      $rows[] = array(
        array(
          'data' => format_date($entry->timestamp),
          'colspan' => 1,
          'class' => $classes,
        ),
        array(
          'data' => format_string($entry->message, $message_vars),
          'colspan' => 2,
          'class' => $classes,
        ),
      );
    }
    $output["log_$lid"] = array(
      '#theme' => 'table',
      '#header' => array(),
      '#rows' => $rows,
    );
    $json['html'] = render($output);
  }

  drupal_json_output($json);
  exit;
}

/**
 * Load statuses of the different jobs and print them as table cells.
 *
 * Prints a json object with a structure like: job id => td table cell (html).
 */
function kms_oci_queue_admin_page_ajax_job_statuses() {
  $status = array();
  foreach (kms_oci_queue_get_job_ids() as $jid) {
    $job = KmsOciQueueJobFactory::get($jid);
    $status[$jid] = _theme_table_cell(array(
      'data' => $job->status->message,
      'data-jid' => $job->jid,
      'class' => array(
        'status',
        KmsOciQueueJob::cssClassStatus($job->status->status),
      ),
    ));
  }
  drupal_json_output(array(
    'status' => $status,
  ));
  exit;
}

/**
 * Generate sql line for a kms_oci_queue job.
 *
 * @param string $type
 *   What type of query. Eg. 'insert'.
 * @param array $data
 *   Query data (':col' => data).
 * @param string $table
 *   Which table is manipulated.
 *
 * @return string
 *   Query.
 */
function _kms_oci_queue_sql_generate_line($type, $data, $table) {
  switch ($type) {
    case 'insert':
      $query = kms_oci_generate_query('insert', $data, array('table' => $table));
      break;
  }

  $patterns = $replacements = array();
  array_walk($data, function($v, $k) use(&$patterns, &$replacements){
    $patterns[] = '#\\' . $k . '#';
    $replacements[] = "'$v'";
  });
  return preg_replace($patterns, $replacements, $query, 1) . ";\n";

}

/**
 * Process a save bundle queue item created by a query creator queue.
 *
 * The function creates sql lines to be written in a kms_oci_queue job file.
 *
 * @param object $item
 *   Queue item.
 *
 * @return string
 *   Sql output.
 */
function _kms_oci_queue_process_perms_query_creator_queue_item($item) {
  $output = $last_perm_name = '';
  array_walk(
    $item->perms,
    function($perms, $perm_name) use ($item, &$output) {
      $perms_oracle_rel = _kms_permissions_perms_oracle_relations();
      // Only handle permissions mentioned in in oracle relations.
      if (empty($perms_oracle_rel[$perm_name])) {
        return;
      }

      $job = KmsOciQueueJobFactory::get($item->jid);
      $perm_conf = $perms_oracle_rel[$perm_name];
      // If the connection id of the job does not match the one in $perm_conf
      // do nothing.
      if ($job->cid != $perm_conf['cid']) {
        return;
      }
      // Create sql line that deletes all data from table owned by current user.
      $output .= sprintf(
        "DELETE FROM %s WHERE USERID = '%s'",
        $perm_conf['table'],
        $item->kms_id
      );
      $output .= ";\n";

      // Create data for insert query line.
      foreach ($perms as $perm) {
        $perm += $perm_conf['default_values'];
        switch ($perm_name) {
          case 'services':
            $data = array(
              ':USERID' => $item->kms_id,
              ':SERVICEID' => $perm['id'],
              ':MINX' => $perm['MINX'],
              ':MINY' => $perm['MINY'],
              ':MAXX' => $perm['MAXX'],
              ':MAXY' => $perm['MAXY'],
              ':MAXPIXELWIDTH' => $perm['MAXPIXELWIDTH'],
              ':MAXPIXELHEIGHT' => $perm['MAXPIXELHEIGHT'],
              ':FEATUREINFO' => $perm['FEATUREINFO'],
            );
            break;

          case 'applications':
            $data = array(
              ':USERID' => $item->kms_id,
              ':GROUPID' => $perm['id'],
            );
            break;
        }
        // Create insert query line.
        $output .= _kms_oci_queue_sql_generate_line(
          'insert',
          $data,
          $perm_conf['table']
        );
      }

    }
  );
  // Return all created query lines.
  return $output;
}

/**
 * Pretty-print JSON string.
 *
 * Use 'format' option to select output format
 * currently html and txt supported, txt is default.
 * Use 'indent' option to override the indentation string set in the format
 * by default for the 'txt' format it's a tab
 *
 * @param string $json
 *   Original JSON string
 * @param array $options
 *   Encoding options
 *
 * @return string
 *   Prettified json.
 */
function kms_oci_queue_json_pretty($json, $options = array()) {
  $tokens = preg_split('|([\{\}\]\[,])|', $json, -1, PREG_SPLIT_DELIM_CAPTURE);
  $result = '';
  $indent = 0;

  $format = 'txt';

  $ind = "    ";

  if (isset($options['format'])) {
    $format = $options['format'];
  }

  switch ($format) {
    case 'html':
      $line_break = '<br />';
      $ind = '&nbsp;&nbsp;&nbsp;&nbsp;';
      break;

    default:
    case 'txt':
      $line_break = "\n";
      $ind = "    ";
      break;
  }

  // Override the defined indent setting with the supplied option.
  if (isset($options['indent'])) {
    $ind = $options['indent'];
  }

  $in_literal = FALSE;
  foreach ($tokens as $token) {
    if ($token == '') {
      continue;
    }

    $prefix = str_repeat($ind, $indent);
    if (!$in_literal && ($token == '{' || $token == '[')) {
      $indent++;
      if (($result != '') && ($result[(strlen($result) - 1)] == $line_break)) {
        $result .= $prefix;
      }
      $result .= $token . $line_break;
    }
    elseif (!$in_literal && ($token == '}' || $token == ']')) {
      $indent--;
      $prefix = str_repeat($ind, $indent);
      $result .= $line_break . $prefix . $token;
    }
    elseif (!$in_literal && $token == ',') {
      $result .= $token . $line_break;
    }
    else {
      $result .= ($in_literal ? '' : $prefix) . $token;

      // Count # of unescaped double-quotes in token, subtract # of
      // escaped double-quotes and if the result is odd then we are
      // inside a string literal.
      if ((substr_count($token, "\"") - substr_count($token, "\\\"")) % 2 != 0) {
        $in_literal = !$in_literal;
      }
    }
  }
  return $result;
}

/**
 * Prepares update user data for oracle insertion.
 *
 * @param object $account
 *   Drupal user account.
 * @param mixed $user
 *   Drupal user object or FALSE.
 *
 * @return array $data
 *   Oracle user data.
 */
function _kms_oci_queue_create_update_smuser_data($account, $user = FALSE) {
  $data = _kms_user_oracle_default_user_data($account, 'update');
  unset($data['user_extra'][':usertype']);
  unset($data['user_extra'][':usertype_info']);

  $data['user'][':disabled'] = (integer)!$account->status;
  if (isset($account->field_address[LANGUAGE_NONE][0]['first_name'])) {
    $data['user'][':firstname']
      = $account->field_address[LANGUAGE_NONE][0]['first_name'];
  }
  if (isset($account->field_address[LANGUAGE_NONE][0]['last_name'])) {
    $data['user'][':lastname']
      = $account->field_address[LANGUAGE_NONE][0]['last_name'];
  }
  if (isset($account->field_phone[LANGUAGE_NONE][0]['value'])) {
    $data['user'][':telephonenumber']
      = $account->field_phone[LANGUAGE_NONE][0]['value'];
  }
  if (isset($account->field_debtor_nr[LANGUAGE_NONE][0]['value'])) {
    $data['user'][':debitorno']
      = $account->field_debtor_nr[LANGUAGE_NONE][0]['value'];
  }
  // smuser_extra.
  if (isset($account->field_user_type[LANGUAGE_NONE][0]['tid'])) {
    $data['user_extra'][':usertype']
      = $account->field_user_type[LANGUAGE_NONE][0]['tid'];
  }
  if (isset($account->field_user_type_info[LANGUAGE_NONE][0]['value'])) {
    $data['user_extra'][':usertype_info']
      = $account->field_user_type_info[LANGUAGE_NONE][0]['value'];
  }
  if (isset($account->field_newsletter[LANGUAGE_NONE][0]['value'])) {
    $data['user_extra'][':receive_newsletter']
      = $account->field_newsletter[LANGUAGE_NONE][0]['value'];
  }
  if (isset($account->field_terms_and_conditions[LANGUAGE_NONE][0]['value'])) {
    $data['user_extra'][':accept_terms'] =
      $account->field_terms_and_conditions[LANGUAGE_NONE][0]['value'];
  }
  if (isset($account->field_contact_me[LANGUAGE_NONE][0]['value'])) {
    $data['user_extra'][':contact_me'] =
      $account->field_contact_me[LANGUAGE_NONE][0]['value'];
  }

  return $data;
}

/**
 * Formats oracle data for insertion.
 *
 * @param object $account
 *   Drupal user account.
 *
 * @return array
 */
function _kms_oci_queue_create_insert_smuser_data($account) {
  $data = _kms_user_oracle_default_user_data($account, 'insert');

  if (isset($account->field_user_type[LANGUAGE_NONE][0]['tid'])) {
    $data['user_extra'][':usertype']
      = $account->field_user_type[LANGUAGE_NONE][0]['tid'];
  }
  if (isset($account->field_user_type_info[LANGUAGE_NONE][0]['value'])) {
    $data['user_extra'][':usertype_info']
      = $account->field_user_type_info[LANGUAGE_NONE][0]['value'];
  }
  if (isset($account->field_newsletter[LANGUAGE_NONE][0]['value'])) {
    $data['user_extra'][':receive_newsletter']
      = $account->field_newsletter[LANGUAGE_NONE][0]['value'];
  }
  if (isset($account->field_terms_and_conditions[LANGUAGE_NONE][0]['value'])) {
    $data['user_extra'][':accept_terms']
      = $account->field_terms_and_conditions[LANGUAGE_NONE][0]['value'];
  }
  if (isset($account->field_contact_me[LANGUAGE_NONE][0]['value'])) {
    $data['user_extra'][':contact_me']
      = $account->field_contact_me[LANGUAGE_NONE][0]['value'];
  }

  return $data;
}


/**
 * Cleanup old jobs cron job.
 */
function kms_oci_queue_cron_cleanup_jobs() {
  // The statuses of the jobs we want to delete.
  $statuses = array('include' => array(KmsOciQueueJob::STATUS_DONE));
  // Get all job ids with the status: 'done'.
  $jids = kms_oci_queue_get_job_ids($statuses);
  // Truncate the array to the given number.
  array_splice($jids, KMS_OCI_QUEUE_CRON_DELETE_JOBS_MAX);
  // Delete jobs and log it.
  foreach($jids as $jid) {
    $job = KmsOciQueueJobFactory::get($jid);
    if (is_object($job)) {
      $job->delete();
      watchdog(
        implode(':', array(KMS_OCI_QUEUE_PREFIX, $jid)),
        'kms_oci_queue_cron_cleanup_jobs deleted job: @jid',
        array('@jid' => $jid)
      );
    }
  }

}
